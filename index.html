
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sistema PRO X</title>
    
    <link rel="icon" type="image/png" href="https://hoff08.github.io/linkine2/logo.png">
    <link rel="apple-touch-icon" href="https://hoff08.github.io/linkine2/logo.png">

    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- SDKs do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-main: #0D0D0F; --bg-card: #1C1D21; --bg-highlight: #3D52D5;
            --accent-primary: #3D52D5; --accent-secondary: #34D399; --accent-red: #E74C3C; --accent-yellow: #F39C12;
            --text-primary: #FFFFFF; --text-secondary: #8A8F98; --border-color: rgba(255, 255, 255, 0.1);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-family); }
        html { background-color: var(--bg-main); }
        html, body { height: 100%; overflow: hidden; }
        body { background-color: var(--bg-main); color: var(--text-primary); display: flex; justify-content: center; align-items: center; font-size: 16px; -webkit-font-smoothing: antialiased; }
        ::-webkit-scrollbar { display: none; }

        .app-container { width: 100%; height: 100%; display: flex; background-color: var(--bg-main); }
        
        .main-content { width:100%; display: flex; flex-direction: column; overflow: hidden; padding-bottom: 90px; }
        .content-area { flex-grow: 1; overflow-y: auto; }
        .content-section { display: none; padding: 24px; } 
        .content-section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 24px; }
        .section-title { font-size: 1.3rem; font-weight: 600; color: var(--text-primary); }
        .add-button { background-color: var(--bg-card); color: var(--text-primary); border: none; font-weight: 600; padding: 10px 16px; border-radius: 12px; cursor: pointer; transition: background-color 0.2s; }
        .no-data-message { color: var(--text-secondary); text-align: center; padding: 20px 0;}

        .search-bar { display: flex; align-items: center; background-color: var(--bg-card); padding: 12px 16px; border-radius: 16px; margin-bottom: 24px; }
        .search-bar input { background: none; border: none; color: var(--text-primary); font-size: 1rem; flex-grow: 1; outline: none; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px; }
        .stat-card { background-color: var(--bg-card); border-radius: 20px; padding: 20px; }
        .stat-card.highlight-card { background-color: var(--bg-highlight); grid-row: span 2; display:flex; flex-direction:column; justify-content:center; }
        .stat-card .card-header { display: flex; align-items: center; margin-bottom: 8px; }
        .card-icon { width: 32px; height: 32px; background-color: rgba(255,255,255,0.1); border-radius: 50%; display:flex; align-items:center; justify-content:center; }
        .highlight-card .card-icon { background-color: rgba(0,0,0,0.2); }
        .stat-card .card-title { font-size: 0.9rem; color: var(--text-secondary); }
        .highlight-card .card-title { color: rgba(255,255,255,0.8); }
        .stat-card .card-value { font-size: 2rem; font-weight: 700; margin-top: 4px; }
        .stock-overview { background-color: var(--bg-card); border-radius: 16px; padding: 16px; display: flex; justify-content: space-around; }
        .stock-item { text-align: center; }
        .stock-item .status { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; color: var(--text-secondary); justify-content: center;}
        .stock-item .status .dot { width: 10px; height: 10px; border-radius: 50%; }
        .stock-item .status .dot.green { background-color: var(--accent-secondary); }
        .stock-item .status .dot.orange { background-color: var(--accent-yellow); }
        .stock-item .status .dot.red { background-color: var(--accent-red); }
        .stock-item .value { font-size: 1.2rem; font-weight: 600; margin-top: 8px; }

        .list-container { background-color: var(--bg-card); border-radius: 16px; padding: 8px 20px; }
        .list-item { display: flex; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border-color); }
        .list-item:last-child { border: none; }
        .list-item-details { flex-grow: 1; min-width: 0; }
        .list-item-title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item-subtitle { font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .delete-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; opacity: 0.5; transition: all 0.2s; padding: 5px; flex-shrink: 0; }
        .delete-btn:hover { opacity: 1; color: var(--accent-red); transform: scale(1.1); }
        .list-item-side-text { font-weight: 700; font-size: 1rem; margin-left:10px; flex-shrink: 0; }
        .side-text-revenue { color: var(--accent-secondary); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: flex-end; }
        .modal-content { background: #1C1D21; padding: 24px; border-radius: 24px 24px 0 0; width: 100%; animation: slideUp 0.3s ease; max-height: 85vh; overflow-y: auto;}
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-content h2 { margin-bottom: 24px; font-size: 1.5rem; text-align: center; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9em; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; background-color: var(--bg-main); border: 1px solid var(--border-color); border-radius: 12px; padding: 14px; color: var(--text-primary); font-size: 1em; }
        .modal-content button { width: 100%; border: none; padding: 14px; font-size: 1em; font-weight: 600; border-radius: 12px; cursor: pointer; margin-top: 10px; }
        .modal-content button[type="submit"] { background: var(--accent-primary); color: #fff; }
        .close-modal-btn { position: absolute; top: 20px; right: 20px; font-size: 28px; cursor: pointer; color: var(--text-secondary); }
        #more-menu-list a { display: block; padding: 15px; font-size: 1.1em; color: var(--text-primary); text-decoration: none; border-bottom: 1px solid var(--border-color); }
        #more-menu-list a:last-child { border-bottom: none; }

        .bottom-tab-bar { display: flex; align-items: center; justify-content: space-around; position: fixed; bottom: 24px; left: 24px; right: 24px; height: 64px; background: #202124; border-radius: 100px; z-index: 100; padding: 0 20px; border: 1px solid #333; }
        .tab-item { background: none; border: none; color: var(--text-secondary); cursor: pointer; transition: color 0.2s; height: 100%; display: flex; align-items: center; justify-content: center; flex-grow: 1; }
        .tab-item.active { color: var(--text-primary); }
        .tab-item svg { width: 26px; height: 26px; pointer-events: none; }
        
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600; text-transform: capitalize; margin-left: 10px; flex-shrink: 0;}
        .status-badge.status-funcional, .status-badge.status-entregue { background-color: rgba(52, 211, 153, 0.2); color: #34D399; }
        .status-badge.status-manutencao, .status-badge.status-planejado { background-color: rgba(251, 191, 36, 0.2); color: #FBBF24; }
        .status-badge.status-quebrado, .status-badge.status-cancelado { background-color: rgba(248, 113, 113, 0.2); color: #F87171; }
        
        .checklist-card ul { list-style: none; padding-top:10px; } .checklist-card li { display: flex; align-items: center; margin-bottom: 10px; }
        .checklist-card input[type="checkbox"] { margin-right: 12px; accent-color: var(--accent-primary); width:18px; height:18px; }
        .checklist-card .add-checklist-item-btn { font-size: 1.2rem; margin-left: auto; background: none; color: var(--accent-primary); border: none; cursor: pointer; }
        
        .ideas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
        .idea-card { background-color: var(--bg-card); border-radius: 18px; overflow: hidden; position: relative; }
        .idea-card .media-container { width: 100%; height: 150px; background-color: var(--bg-main); display: flex; align-items: center; justify-content: center; }
        .idea-card .media-container img, .idea-card .media-container iframe { width: 100%; height: 100%; object-fit: cover; border: none; }
        .idea-card .title { padding: 15px; font-weight: 600; }
        
        .chart-container { background-color: var(--bg-card); padding: 20px; border-radius: 20px; height: 350px; margin-top: 24px; }

        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .calendar-header h2 { font-size: 1.3rem; font-weight: 600; color: var(--text-primary); }
        .calendar-nav-btn { background: var(--bg-card); border: none; color: var(--text-primary); padding: 8px 12px; border-radius: 10px; cursor: pointer; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-weekday { text-align: center; font-weight: 600; color: var(--text-secondary); font-size: 0.8rem; padding-bottom: 10px; }
        .calendar-day { border: 1px solid var(--border-color); min-height: 100px; border-radius: 12px; padding: 8px; font-size: 0.8rem; transition: background-color 0.2s; }
        .calendar-day.can-add:hover { background-color: var(--bg-card); cursor: pointer; }
        .calendar-day.today { background-color: var(--bg-highlight); border-color: var(--accent-primary); }
        .calendar-day.not-current-month { color: var(--text-secondary); opacity: 0.5; }
        .calendar-day-number { font-weight: 600; }
        .calendar-event { background-color: var(--accent-primary); color: white; padding: 4px 6px; border-radius: 6px; font-size: 0.7rem; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .calendar-event:hover { opacity: 0.8; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="main-content">
            <main class="content-area" id="content-area">
                <div id="visao-geral-content" class="content-section"></div>
                <div id="agenda-content" class="content-section"></div>
                <div id="tarefas-content" class="content-section"></div>
                <div id="projetos-content" class="content-section"></div>
                <div id="clientes-content" class="content-section"></div>
                <div id="financeiro-content" class="content-section"></div>
                <div id="equipamentos-content" class="content-section"></div>
                <div id="checklist-content" class="content-section"></div>
                <div id="ideias-content" class="content-section"></div>
                <div id="relatorios-content" class="content-section"></div>
                <div id="marketing-content" class="content-section"></div>
            </main>
        </div>
        
        <nav class="bottom-tab-bar">
            <button class="tab-item active" data-section="visao-geral" title="Início"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><path d="M9 22V12h6v10"></path></svg></button>
            <button class="tab-item" data-section="agenda" title="Agenda"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" y2="6"></line><line x1="8" y1="2" y2="6"></line><line x1="3" y1="10" y2="10"></line></svg></button>
            <button class="tab-item" data-section="projetos" title="Projetos"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg></button>
            <button class="tab-item" data-section="financeiro" title="Financeiro"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></button>
            <button class="tab-item" id="more-menu-btn" title="Mais"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></button>
        </nav>
        
        <div id="modal-container"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- SUA CONFIGURAÇÃO DO FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyDFL1oGl-Vn9rqeW6xqp_IIu9VJXkYtWfk",
      authDomain: "clickai-400b2.firebaseapp.com",
      databaseURL: "https://clickai-400b2-default-rtdb.firebaseio.com",
      projectId: "clickai-400b2",
      storageBucket: "clickai-400b2.firebasestorage.app",
      messagingSenderId: "742389242413",
      appId: "1:742389242413:web:cd9d6d7d1fefdb7d81b6a4"
    };

    // --- INICIALIZAÇÃO DO APP ---
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    const getEl = (id) => document.getElementById(id);
    const modalContainer = getEl('modal-container');
    const contentArea = getEl('content-area');

    // --- ARMAZENAMENTO LOCAL DOS DADOS ---
    // Este objeto irá guardar os dados recebidos do Firebase
    let localData = {
        projects: {}, clients: {}, schedule: {}, tasks: {}, expenses: {}, revenues: {}, toReceive: {}, 
        equipment: {}, checklist: { pre: {}, dia: {}, pos: {} }, inspirations: {}, marketingPosts: {}
    };

    let currentSection = 'visao-geral';
    let calendarDate = new Date();
    let trajectoryChartInstance = null;
    
    // --- FUNÇÕES UTILITÁRIAS ---
    const formatCurrency = (value) => (typeof value === 'number' ? value : 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const escapeHtml = (unsafe) => unsafe ? String(unsafe).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]) : "";
    const dataAsArray = (dataObject) => dataObject ? Object.entries(dataObject).map(([id, value]) => ({...value, id })) : [];
    
    // --- CARREGAMENTO DE DADOS (OTIMIZADO) ---
    const setupDataListeners = () => {
        const dataPaths = ['projects', 'clients', 'schedule', 'revenues', 'toReceive', 'equipment', 'checklist', 'inspirations', 'marketingPosts'];
        dataPaths.forEach(path => {
            database.ref(path).on('value', (snapshot) => {
                localData[path] = snapshot.val() || (path === 'checklist' ? {} : {});
                // Re-renderiza a página somente se a seção atual depender desses dados
                if (document.getElementById(`${currentSection}-content`)?.classList.contains('active')) {
                    renderPage(currentSection);
                }
            });
        });
    };

    // --- RENDERIZAÇÃO DE PÁGINAS ---
    const renderPage = (sectionId) => {
        currentSection = sectionId;
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        const sectionDiv = getEl(`${sectionId}-content`);
        if (sectionDiv) {
            sectionDiv.classList.add('active');
            if (window.templates[sectionId]) {
                sectionDiv.innerHTML = window.templates[sectionId]();
                if (window.renderFunctions[sectionId]) window.renderFunctions[sectionId]();
            }
        }
        
        document.querySelectorAll('.bottom-tab-bar .tab-item').forEach(l => l.classList.remove('active'));
        const activeTab = document.querySelector(`.tab-item[data-section="${sectionId}"]`);
        if (activeTab) activeTab.classList.add('active');
        else getEl('more-menu-btn').classList.add('active');
    };
    
    // --- MODAIS ---
    const openModal = (modalHTML) => {
        modalContainer.innerHTML = modalHTML;
        const modal = modalContainer.querySelector('.modal');
        modal.style.display = 'flex';
        const closeModalFunc = () => { modal.style.display = 'none'; modalContainer.innerHTML = ''; };
        modal.onclick = (e) => { if (e.target === modal) closeModalFunc(); };
        modal.querySelector('.close-modal-btn')?.addEventListener('click', closeModalFunc);
    };
    const closeModal = () => {
        const modal = modalContainer.querySelector('.modal');
        if (modal) { modal.style.display = 'none'; modalContainer.innerHTML = ''; }
    };

    // --- LÓGICA DE CRUD (Criar, Ler, Atualizar, Deletar) OTIMIZADA ---
    const handleFormSubmit = (e, itemType) => {
        e.preventDefault();
        const form = e.target;
        const newItem = {};
        Array.from(form.elements).forEach(el => { if(el.name) newItem[el.name] = el.value; });
        
        database.ref(itemType).push(newItem); // Usa .push() para criar um novo item com ID único
        
        closeModal();
    };

    const handleScheduleFormSubmit = (e) => {
        e.preventDefault();
        const form = e.target;
        const eventId = form.elements.id ? form.elements.id.value : null;
        const eventData = {
            date: form.elements.date.value,
            time: form.elements.time.value,
            task: form.elements.task.value
        };

        if (eventId) { // Edit Mode
            database.ref('schedule/' + eventId).update(eventData);
        } else { // Create Mode
            database.ref('schedule').push(eventData);
        }
        closeModal();
    };
    
    const handleDelete = (id, itemType, category = null) => {
        if (confirm(`Tem certeza que deseja excluir este item?`)) {
            const path = category ? `${itemType}/${category}/${id}` : `${itemType}/${id}`;
            database.ref(path).remove();
        }
    };

    // --- MANIPULADORES DE EVENTOS (CLICKS) ---
    const handleContentClick = (e) => {
        const addBtn = e.target.closest('.add-button');
        if (addBtn) { openAndHandleModal(addBtn.dataset.type); return; }
        
        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
            const { id, type, category } = deleteBtn.dataset;
            if (id && type) handleDelete(id, type, category);
            return;
        }

        const calendarEvent = e.target.closest('.calendar-event');
        if (calendarEvent && calendarEvent.dataset.id) {
            openAndHandleModal('agenda', null, calendarEvent.dataset.id);
            return;
        }

        const calendarDay = e.target.closest('.calendar-day.can-add');
        if (calendarDay && calendarDay.dataset.date) {
            openAndHandleModal('agenda', calendarDay.dataset.date);
            return;
        }
        
        const markAsPaidBtn = e.target.closest('.mark-as-paid-btn');
        if (markAsPaidBtn) {
            const itemId = markAsPaidBtn.dataset.id;
            const itemToPay = localData.toReceive[itemId];
            if (itemToPay) {
                const newRevenue = { 
                    description: itemToPay.description, 
                    amount: itemToPay.amount, 
                    date: new Date().toISOString().slice(0, 10) 
                };
                database.ref('revenues').push(newRevenue);
                database.ref('toReceive/' + itemId).remove();
            }
        }
    };

    const openAndHandleModal = (type, date = null, itemId = null) => {
        let modalHTML = '', formId = '', itemType = '';
        switch (type) {
            case 'agenda':
                const isEditing = itemId !== null;
                const event = isEditing ? (localData.schedule[itemId] || {}) : { date: date || new Date().toISOString().slice(0, 10), time: '', task: '' };
                modalHTML = `<div class="modal"><div class="modal-content"><span class="close-modal-btn">&times;</span><h2>${isEditing ? 'Editar' : 'Novo'} Compromisso</h2><form id="schedule-form">
                    ${isEditing ? `<input type="hidden" name="id" value="${itemId}">` : ''}
                    <div class="form-group"><label>Data</label><input type="date" name="date" value="${escapeHtml(event.date)}" required></div>
                    <div class="form-group"><label>Hora</label><input type="time" name="time" value="${escapeHtml(event.time)}" required></div>
                    <div class="form-group"><label>Compromisso</label><input type="text" name="task" value="${escapeHtml(event.task)}" required></div>
                    <button type="submit">${isEditing ? 'Salvar Alterações' : 'Adicionar'}</button>
                    ${isEditing ? `<button type="button" id="delete-event-btn" style="background-color: var(--accent-red);">Excluir</button>` : ''}
                    </form></div></div>`;
                openModal(modalHTML);
                getEl('schedule-form').onsubmit = handleScheduleFormSubmit;
                if (isEditing) getEl('delete-event-btn').onclick = () => { handleDelete(itemId, 'schedule'); closeModal(); };
                return;
            case 'projetos': formId = 'project-form'; itemType = 'projects';
                let clientOptions = dataAsArray(localData.clients).map(c => `<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');
                modalHTML = `<div class="modal"><div class="modal-content"><span class="close-modal-btn">&times;</span><h2>Novo Projeto</h2><form id="${formId}"><div class="form-group"><label>Nome do Projeto</label><input type="text" name="name" required></div><div class="form-group"><label>Cliente</label><select name="client" required><option value="">Selecione</option>${clientOptions}</select></div><button type="submit">Adicionar</button></form></div></div>`; break;
            case 'clientes': formId = 'client-form'; itemType = 'clients';
                modalHTML = `<div class="modal"><div class="modal-content"><span class="close-modal-btn">&times;</span><h2>Novo Cliente</h2><form id="${formId}"><div class="form-group"><label>Nome</label><input type="text" name="name" required></div><div class="form-group"><label>Contato</label><input type="text" name="contact"></div><button type="submit">Salvar</button></form></div></div>`; break;
            case 'revenue': formId = 'revenue-form'; itemType = 'revenues';
                modalHTML = `<div class="modal"><div class="modal-content"><span class="close-modal-btn">&times;</span><h2>Nova Receita</h2><form id="${formId}"><div class="form-group"><label>Descrição</label><input type="text" name="description" required></div><div class="form-group"><label>Valor</label><input type="number" step="0.01" name="amount" required></div><div class="form-group"><label>Data</label><input type="date" name="date" required value="${new Date().toISOString().slice(0,10)}"></div><button type="submit">Adicionar</button></form></div></div>`; break;
            case 'toReceive': formId = 'to-receive-form'; itemType = 'toReceive';
                modalHTML = `<div class="modal"><div class="modal-content"><span class="close-modal-btn">&times;</span><h2>Nova Conta a Receber</h2><form id="${formId}"><div class="form-group"><label>Descrição</label><input type="text" name="description" required></div><div class="form-group"><label>Valor</label><input type="number" step="0.01" name="amount" required></div><div class="form-group"><label>Data de Vencimento</label><input type="date" name="dueDate" required value="${new Date().toISOString().slice(0,10)}"></div><button type="submit">Adicionar</button></form></div></div>`; break;
            case 'equipamentos': formId = 'equipment-form'; itemType = 'equipment';
                modalHTML = `<div class="modal"><div class="modal-content"><span class="close-modal-btn">&times;</span><h2>Novo Equipamento</h2><form id="${formId}"><div class="form-group"><label>Item</label><input type="text" name="item" required></div><div class="form-group"><label>Modelo</label><input type="text" name="model"></div><div class="form-group"><label>Status</label><select name="status"><option value="funcional">Funcional</option><option value="manutencao">Manutenção</option><option value="quebrado">Quebrado</option></select></div><button type="submit">Adicionar</button></form></div></div>`; break;
            case 'marketing': formId = 'post-form'; itemType = 'marketingPosts';
                modalHTML = `<div class="modal"><div class="modal-content"><span class="close-modal-btn">&times;</span><h2>Novo Post</h2><form id="${formId}"><div class="form-group"><label>Conteúdo</label><input type="text" name="content" required></div><div class="form-group"><label>Canal</label><select name="channel"><option>Instagram</option><option>TikTok</option><option>Blog</option></select></div><div class="form-group"><label>Status</label><select name="status"><option value="planejado">Planejado</option><option value="entregue">Entregue</option><option value="cancelado">Cancelado</option></select></div><button type="submit">Adicionar</button></form></div></div>`; break;
            case 'ideias':
                modalHTML = `<div class="modal"><div class="modal-content"><span class="close-modal-btn">&times;</span><h2>Nova Ideia</h2><form id="idea-form"><div class="form-group"><label>Título</label><input type="text" name="title" required></div><div class="form-group"><label>Link do Vídeo (YouTube)</label><input type="text" name="videoUrl"></div><div class="form-group"><label>Ou Imagem</label><input type="file" name="imageFile" accept="image/*"></div><button type="submit">Adicionar</button></form></div></div>`;
                openModal(modalHTML);
                getEl('idea-form').onsubmit = (e) => {
                    e.preventDefault();
                    const title = e.target.title.value, videoUrl = e.target.videoUrl.value, imageFile = e.target.imageFile.files[0];
                    if (imageFile) {
                        const reader = new FileReader();
                        reader.onloadend = () => { database.ref('inspirations').push({ title, type: 'image', data: reader.result }); };
                        reader.readAsDataURL(imageFile);
                    } else if (videoUrl) { database.ref('inspirations').push({ title, type: 'video', data: videoUrl }); }
                    closeModal();
                }; return;
        }
        openModal(modalHTML);
        if (formId) getEl(formId).onsubmit = (e) => handleFormSubmit(e, itemType);
    };

    // --- TEMPLATES E FUNÇÕES DE RENDERIZAÇÃO ---
    window.templates = {}; window.renderFunctions = {};
    
    templates['visao-geral'] = () => `<div class="search-bar"><input type="text" placeholder="Buscar..."></div><div class="stats-grid"><div class="stat-card highlight-card"><div class="card-header"><div class="card-icon">↗</div></div><div><div class="card-title">Total de Projetos</div><div class="card-value" id="summary-total-projects">0</div></div></div><div class="stat-card"><div class="card-header"><div class="card-icon">↗</div></div><div class="card-title">Pagamentos Recebidos</div><div class="card-value" id="summary-total-payment">R$ 0,00</div></div><div class="stat-card"><div class="card-header"><div class="card-icon">↗</div></div><div class="card-title">Clientes</div><div class="card-value" id="summary-total-clients">0</div></div></div><h2 class="section-title" style="margin-bottom: 16px;">Visão Geral do Estoque</h2><div class="stock-overview"><div class="stock-item"><div class="status"><span class="dot green"></span> Funcional</div><div class="value" id="stock-in-stock">0</div></div><div class="stock-item"><div class="status"><span class="dot orange"></span> Manutenção</div><div class="value" id="stock-low-stock">0</div></div><div class="stock-item"><div class="status"><span class="dot red"></span> Quebrado</div><div class="value" id="stock-out-of-stock">0</div></div></div>`;
    renderFunctions['visao-geral'] = () => {
        const projects = dataAsArray(localData.projects);
        const revenues = dataAsArray(localData.revenues);
        const clients = dataAsArray(localData.clients);
        const equipment = dataAsArray(localData.equipment);
        
        getEl('summary-total-projects').textContent = projects.length;
        getEl('summary-total-payment').textContent = formatCurrency(revenues.reduce((sum, r) => sum + parseFloat(r.amount || 0), 0));
        getEl('summary-total-clients').textContent = clients.length;
        getEl('stock-in-stock').textContent = equipment.filter(e => e.status === 'funcional').length;
        getEl('stock-low-stock').textContent = equipment.filter(e => e.status === 'manutencao').length;
        getEl('stock-out-of-stock').textContent = equipment.filter(e => e.status === 'quebrado').length;
    };
    
    templates.agenda = () => `<div class="calendar-header"><button id="prev-month-btn" class="calendar-nav-btn">‹</button><h2 id="month-year-display"></h2><button id="next-month-btn" class="calendar-nav-btn">›</button></div><div class="calendar-grid"><div class="calendar-weekday">DOM</div><div class="calendar-weekday">SEG</div><div class="calendar-weekday">TER</div><div class="calendar-weekday">QUA</div><div class="calendar-weekday">QUI</div><div class="calendar-weekday">SEX</div><div class="calendar-weekday">SÁB</div></div><div class="calendar-grid" id="calendar-body"></div>`;
    renderFunctions.agenda = () => {
        const calendarBody = getEl('calendar-body'), monthYearDisplay = getEl('month-year-display');
        const year = calendarDate.getFullYear(), month = calendarDate.getMonth();
        monthYearDisplay.textContent = new Date(year, month).toLocaleString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();
        const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date(), todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        
        const scheduleArray = dataAsArray(localData.schedule);

        calendarBody.innerHTML = Array(firstDay).fill('<div class="calendar-day not-current-month"></div>').join('');
        for (let day = 1; day <= daysInMonth; day++) {
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayEvents = scheduleArray.filter(s => s.date === dateString).sort((a,b) => a.time.localeCompare(b.time));
            const eventsHTML = dayEvents.map(event => `<div class="calendar-event" data-id="${event.id}">${escapeHtml(event.time)} - ${escapeHtml(event.task)}</div>`).join('');
            calendarBody.innerHTML += `<div class="calendar-day can-add ${dateString === todayString ? 'today' : ''}" data-date="${dateString}"><div class="calendar-day-number">${day}</div>${eventsHTML}</div>`;
        }
        getEl('prev-month-btn').onclick = () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderPage('agenda'); };
        getEl('next-month-btn').onclick = () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderPage('agenda'); };
    };
    
    templates.projetos = () => `<div class="section-header"><h2 class="section-title">Projetos</h2><button class="add-button" data-type="projetos">Adicionar</button></div><div id="project-list"></div>`;
    renderFunctions.projetos = () => {
        const container = getEl('project-list'), projects = dataAsArray(localData.projects);
        container.innerHTML = projects.length === 0 ? `<div class="list-container"><p class="no-data-message">Nenhum projeto cadastrado.</p></div>` : projects.map(p => `<div class="list-container" style="margin-bottom:12px;"><div class="list-item"><div class="list-item-details"><div class="list-item-title">${escapeHtml(p.name)}</div><div class="list-item-subtitle">${escapeHtml(p.client)}</div></div><button class="delete-btn" data-id="${p.id}" data-type="projects">🗑️</button></div></div>`).join('');
    };

    templates.clientes = () => `<div class="section-header"><h2 class="section-title">Clientes</h2><button class="add-button" data-type="clientes">Adicionar</button></div><div id="client-list"></div>`;
    renderFunctions.clientes = () => {
        const list = getEl('client-list'), clients = dataAsArray(localData.clients);
        list.innerHTML = clients.length === 0 ? `<div class="list-container"><p class="no-data-message">Nenhum cliente cadastrado.</p></div>` : `<div class="list-container">${clients.map(c => `<div class="list-item"><div class="list-item-details"><div class="list-item-title">${escapeHtml(c.name)}</div><div class="list-item-subtitle">${escapeHtml(c.contact)}</div></div><button class="delete-btn" data-id="${c.id}" data-type="clients">🗑️</button></div>`).join('')}</div>`;
    };
    
    templates.financeiro = () => `<div class="section-header"><h2 class="section-title">Financeiro</h2><div><button class="add-button" data-type="revenue" style="margin-right:10px;">+ Receita</button><button class="add-button" data-type="toReceive" style="background-color: var(--accent-yellow); color: var(--bg-main);">+ A Receber</button></div></div><h3 style="margin:24px 0 16px;font-size:1.1rem;color:var(--accent-yellow);">Contas a Receber</h3><div class="list-container" id="to-receive-list"></div><h3 style="margin:24px 0 16px;font-size:1.1rem;">Histórico de Transações</h3><div class="list-container" id="transaction-list"></div>`;
    renderFunctions.financeiro = () => {
        const toReceiveList = getEl('to-receive-list'), pendingRevenues = dataAsArray(localData.toReceive).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
        toReceiveList.innerHTML = pendingRevenues.length === 0 ? `<p class="no-data-message">Nenhuma conta a receber.</p>` : pendingRevenues.map(t => `<div class="list-item"><div class="list-item-details"><div class="list-item-title">${escapeHtml(t.description)}</div><div class="list-item-subtitle">Vence em: ${escapeHtml(t.dueDate)}</div></div><div class="list-item-side-text side-text-revenue">${formatCurrency(parseFloat(t.amount))}</div><button class="add-button mark-as-paid-btn" data-id="${t.id}" style="margin-left:10px;background-color:var(--accent-secondary);font-size:0.8em;padding:8px 12px;">Pago</button></div>`).join('');
        const transactionList = getEl('transaction-list'), transactions = dataAsArray(localData.revenues).sort((a,b) => new Date(b.date) - new Date(a.date));
        transactionList.innerHTML = transactions.length === 0 ? `<p class="no-data-message">Nenhuma transação registrada.</p>` : transactions.map(t => `<div class="list-item"><div class="list-item-details"><div class="list-item-title">${escapeHtml(t.description)}</div><div class="list-item-subtitle">${escapeHtml(t.date)}</div></div><div class="list-item-side-text side-text-revenue">+ ${formatCurrency(parseFloat(t.amount))}</div></div>`).join('');
    };

    templates.equipamentos = () => `<div class="section-header"><h2 class="section-title">Equipamentos</h2><button class="add-button" data-type="equipamentos">Adicionar</button></div><div id="equipment-list"></div>`;
    renderFunctions.equipamentos = () => {
        const list = getEl('equipment-list'), equipment = dataAsArray(localData.equipment);
        list.innerHTML = equipment.length === 0 ? `<p class="no-data-message">Nenhum equipamento cadastrado.</p>` : `<div class="list-container">${equipment.map(eq => `<div class="list-item"><div class="list-item-details"><div class="list-item-title">${escapeHtml(eq.item)}</div><div class="list-item-subtitle">${escapeHtml(eq.model)}</div></div><span class="status-badge status-${eq.status}">${eq.status}</span><button class="delete-btn" data-id="${eq.id}" data-type="equipment">🗑️</button></div>`).join('')}</div>`;
    };

    templates.checklist = () => `<div class="section-header"><h2 class="section-title">Checklist</h2></div><div class="list-container" style="margin-bottom:24px;"><div class="section-header"><h3>Pré-Produção</h3><button class="add-checklist-item-btn" data-category="pre">+</button></div><ul id="checklist-pre"></ul></div><div class="list-container" style="margin-bottom:24px;"><div class="section-header"><h3>Dia do Job</h3><button class="add-checklist-item-btn" data-category="dia">+</button></div><ul id="checklist-dia"></ul></div><div class="list-container"><div class="section-header"><h3>Pós-Produção</h3><button class="add-checklist-item-btn" data-category="pos">+</button></div><ul id="checklist-pos"></ul></div>`;
    renderFunctions.checklist = () => {
        const renderCategory = (key) => { 
            const items = dataAsArray(localData.checklist[key]);
            getEl(`checklist-${key}`).innerHTML = items.map(item => `<li><label><input type="checkbox" data-id="${item.id}" data-category="${key}" ${item.checked ? 'checked' : ''}> ${escapeHtml(item.text)}</label><button class="delete-btn" data-id="${item.id}" data-type="checklist" data-category="${key}">🗑️</button></li>`).join(''); 
        };
        ['pre', 'dia', 'pos'].forEach(renderCategory);
        document.querySelectorAll('.add-checklist-item-btn').forEach(btn => btn.onclick = (e) => { const category = e.target.dataset.category, text = prompt('Nova tarefa:'); if (text) { database.ref(`checklist/${category}`).push({ text, checked: false }); } });
        document.querySelectorAll('.list-container input[type=checkbox]').forEach(box => box.onchange = (e) => { const { id, category } = e.target.dataset; database.ref(`checklist/${category}/${id}/checked`).set(e.target.checked); });
    };
    
    templates.ideias = () => `<div class="section-header"><h2 class="section-title">Ideias</h2><button class="add-button" data-type="ideias">Adicionar</button></div><div class="ideas-grid" id="ideas-grid"></div>`;
    renderFunctions.ideias = () => {
        const grid = getEl('ideas-grid'), inspirations = dataAsArray(localData.inspirations);
        if (inspirations.length === 0) grid.innerHTML = `<p class="no-data-message" style="width:100%;">Nenhuma ideia salva.</p>`;
        else grid.innerHTML = inspirations.map(i => {
            let mediaHTML = '';
            if (i.type === 'image') mediaHTML = `<img src="${i.data}" alt="${escapeHtml(i.title)}">`;
            else if (i.type === 'video') { const videoId = i.data.split('v=')[1]?.split('&')[0] || i.data.split('/').pop(); mediaHTML = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`; }
            return `<div class="idea-card"><div class="media-container">${mediaHTML}</div><div class="title">${escapeHtml(i.title)}</div><button class="delete-btn" data-id="${i.id}" data-type="inspirations" style="position:absolute;top:10px;right:10px;">🗑️</button></div>`;
        }).join('');
    };

    templates.relatorios = () => `<div class="section-header"><h2 class="section-title">Relatórios</h2></div><div class="chart-container"><canvas id="trajectoryChart"></canvas></div>`;
    renderFunctions.relatorios = () => {
        const chartCtx = getEl('trajectoryChart')?.getContext('2d'); if (!chartCtx) return;
        if (trajectoryChartInstance) trajectoryChartInstance.destroy();
        trajectoryChartInstance = new Chart(chartCtx, { type: 'line', data: { labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai'], datasets: [{ label: 'Receitas', data: [1200, 1900, 3000, 5000, 2300], borderColor: 'var(--accent-secondary)', tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false } });
    };

    templates.marketing = () => `<div class="section-header"><h2 class="section-title">Marketing</h2><button class="add-button" data-type="marketing">Adicionar Post</button></div><div id="marketing-list"></div>`;
    renderFunctions.marketing = () => {
        const list = getEl('marketing-list'), posts = dataAsArray(localData.marketingPosts);
        list.innerHTML = posts.length === 0 ? `<div class="list-container"><p class="no-data-message">Nenhum post planejado.</p></div>` : `<div class="list-container">${posts.map(p => `<div class="list-item"><div class="list-item-details"><div class="list-item-title">${escapeHtml(p.content)}</div><div class="list-item-subtitle">${escapeHtml(p.channel)}</div></div><span class="status-badge status-${p.status}">${p.status}</span><button class="delete-btn" data-id="${p.id}" data-type="marketingPosts">🗑️</button></div>`).join('')}</div>`;
    };

    // --- INICIALIZAÇÃO DO APLICATIVO ---
    const initializeApp = () => {
        contentArea.addEventListener('click', handleContentClick);
        document.querySelector('.bottom-tab-bar').addEventListener('click', (e) => {
            const link = e.target.closest('.tab-item');
            if (link && link.id !== 'more-menu-btn') renderPage(link.dataset.section);
        });
        getEl('more-menu-btn').onclick = () => {
            const modalHTML = `<div class="modal"><div class="modal-content" style="border-radius:24px;"><span class="close-modal-btn">&times;</span><div id="more-menu-list">
                <h2 style="margin-bottom:10px;">Mais Seções</h2>
                <a href="#" data-section="clientes">Clientes</a><a href="#" data-section="equipamentos">Equipamentos</a><a href="#" data-section="checklist">Checklist</a>
                <a href="#" data-section="ideias">Ideias</a><a href="#" data-section="marketing">Marketing</a><a href="#" data-section="relatorios">Relatórios</a>
            </div></div></div>`;
            openModal(modalHTML);
            getEl('more-menu-list').onclick = (e) => {
                e.preventDefault();
                const link = e.target.closest('a[data-section]');
                if(link) { renderPage(link.dataset.section); closeModal(); }
            };
        };

        // Renderiza a UI inicial e depois carrega os dados
        renderPage(currentSection);
        setupDataListeners();
    };

    initializeApp();
});
</script>

</body>
</html>
